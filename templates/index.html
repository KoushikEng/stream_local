<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <title>Local Media Streamer</title>
    <link rel="shortcut icon" href="favicon.ico?v=1" type="image/x-icon">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1 { color: #333; }
        /* --- Existing Styles --- */
        .breadcrumbs { margin-bottom: 15px; padding: 10px; }
        .breadcrumbs a { color: #0066cc; text-decoration: none; }
        .breadcrumbs a:hover { text-decoration: underline; }
        .current-path { font-size: 1.1em; margin-bottom: 15px; color: #666; }
        
        .folder-list { margin-bottom: 30px; }
        .folder-item { margin: 5px 0; padding: 10px; background: white; border-radius: 4px; border-left: 4px solid #0066cc; }
        .folder-item a { color: #333; text-decoration: none; font-weight: bold; display: block; }
        .folder-item:hover { background: #f0f7ff; }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .media-item {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .media-item:hover { transform: scale(1.03); box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10; }

        .media-thumbnail-container { position: relative; width: 100%; height: 140px; background: #000; }
        .media-thumbnail { width: 100%; height: 100%; object-fit: cover; }
        
        .video-preview {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; display: none;
        }
        .type-indicator {
            position: absolute; top: 5px; right: 5px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 2px 6px; border-radius: 4px;
            font-size: 0.7em; font-weight: bold;
        }
        .media-title {
            padding: 10px; font-size: 0.9em; word-break: break-word;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #444;
        }

        video {
            outline: none;
        }
        
        /* --- Viewer & Navigation Styles --- */
        #viewer-container {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            flex-direction: column; justify-content: center; align-items: center;

            /* CRITICAL: This prevents Chrome from handling swipes for history navigation */
            touch-action: none;
        }

        #viewer-content {
            position: relative;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        #video-player { width: 100%; height: 100%; /* max-height: 90vh; max-width: 90vw; */ }
        #image-viewer { max-width: 100vw; max-height: 100vh; object-fit: contain; }

        /* --- Controls (Buttons) --- */
        .control-element {
            transition: opacity 0.5s ease;
            opacity: 1;
        }

        /* When the container has the 'idle' class, hide controls */
        #viewer-container.idle .control-element {
            opacity: 0;
            pointer-events: none; /* Prevent clicking hidden buttons */
        }
        
        /* Navigation Buttons */
        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            font-size: 3rem;
            padding: 20px;
            cursor: pointer;
            z-index: 1002;
            transition: background 0.3s;
            user-select: none;
            border-radius: 5px;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .prev-btn { left: 10px; }
        .next-btn { right: 10px; }

        /* Hide buttons on small mobile screens to prevent obstruction (users will swipe) */
        @media (max-width: 600px) {
            .nav-btn { display: none; }
        }

        #close-btn {
            position: absolute; top: 20px; right: 20px;
            color: white; background: rgba(255, 255, 255, 0.2);
            border: 1px solid white; padding: 8px 15px;
            cursor: pointer; z-index: 1003; border-radius: 4px;
        }
        #close-btn:hover { background: rgba(255, 255, 255, 0.4); }

        /* Loading Spinner */
        #loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite;
            position: absolute; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media screen and (max-width: 768px) {
            .media-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
            .media-thumbnail-container { height: 100px; }
        }
    </style>
</head>
<body>
    <h1>Local Media Streamer</h1>
    
    <div class="breadcrumbs">
        <a href="/">Home</a>
        {% for crumb in breadcrumbs %}
            &raquo; <a href="/?folder={{ crumb.path }}">{{ crumb.name }}</a>
        {% endfor %}
    </div>
    
    <div class="current-path">
        {% if current_folder %} üìÇ {{ current_folder }} {% else %} Root Directory {% endif %}
    </div>
    
    {% if contents.subfolders %}
    <div class="folder-list">
        <h3>Folders</h3>
        {% for folder in contents.subfolders %}
            <div class="folder-item">
                <a href="/?folder={{ path.join(current_folder, folder) if current_folder else folder }}">
                    üìÅ {{ folder }}
                </a>
            </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if contents.media %}
    <div class="media-grid">
        {% for item in contents.media %}
            <div class="media-item" 
                 onclick="openViewer({{ loop.index0 }})"
                 {% if item.type == 'video' %}
                 onmouseenter="startPreview(this, '{{ item.preview }}')"
                 onmouseleave="stopPreview(this)"
                 {% endif %}
                 >
                <div class="media-thumbnail-container">
                    <span class="type-indicator">{{ item.type|upper }}</span>
                    <img src="{{ item.thumbnail }}" class="media-thumbnail" alt="{{ item.name }}" loading="lazy">
                    {% if item.type == 'video' %}
                        <video class="video-preview" loop muted preload="none"></video>
                    {% endif %}
                </div>
                <div class="media-title">{{ item.name }}</div>
            </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if not contents.subfolders and not contents.media %}
        <p>No media found in this directory.</p>
    {% endif %}

    <div id="viewer-container">
        <button id="close-btn" class="control-element" onclick="closeViewer()">‚úï Close (ESC)</button>
        
        <div id="viewer-content">
            <button class="nav-btn prev-btn control-element" onclick="navigate(-1)">&#10094;</button>
            
            <div id="loader"></div>
            <video id="video-player" controls style="display: none;"></video>
            <img id="image-viewer" src="" style="display: none;">
            
            <button class="nav-btn next-btn control-element" onclick="navigate(1)">&#10095;</button>
        </div>
    </div>

    <script>
        // --- 1. DATA INJECTION ---
        // We inject the Python list directly into JS. 
        // Note: Jinja's tojson is safe and handles escaping.
        const playlist = {{ contents.media | tojson }};
        let currentIndex = 0;
        let scrollPosition = 0;
        let idleTimer = null;
        let isViewerOpen = false;

        const viewerContainer = document.getElementById('viewer-container');
        const videoPlayer = document.getElementById('video-player');
        const imageViewer = document.getElementById('image-viewer');
        const loader = document.getElementById('loader');

        // --- 2. CORE VIEWER LOGIC ---

        function openViewer(index) {
            if (index < 0 || index >= playlist.length) return;
            
            currentIndex = index;
            scrollPosition = window.scrollY;
            isViewerOpen = true;
            
            // Push a state so "Back Button" works
            history.pushState({ viewerOpen: true }, "", "#view");
            
            viewerContainer.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            loadMedia(currentIndex);
            resetIdleTimer(); // Start the inactivity timer
        }

        // The central function to actually hide the DOM elements
        function hideViewerDOM() {
            viewerContainer.style.display = 'none';
            videoPlayer.pause();
            videoPlayer.src = '';
            imageViewer.src = '';
            document.body.style.overflow = 'auto';
            
            // If we have a scroll position, restore it
            if (scrollPosition) window.scrollTo(0, scrollPosition);
            isViewerOpen = false;
        }

        // Triggered by the "X" button or Escape key
        function closeViewer() {
            if (isViewerOpen) {
                // We go back in history. This triggers the 'popstate' event below.
                // We do NOT call hideViewerDOM() directly here, to ensure logic is unified.
                history.back(); 
            }
        }

        // Triggered when user hits Browser Back Button OR history.back() is called
        window.addEventListener('popstate', (event) => {
            // If we are coming BACK from the viewer state, hide the viewer
            if (isViewerOpen) {
                hideViewerDOM();
            }
        });

        function loadMedia(index) {
            const item = playlist[index];
            if (!item) return;

            // Reset Display
            videoPlayer.style.display = 'none';
            videoPlayer.pause();
            imageViewer.style.display = 'none';
            loader.style.display = 'block';

            if (item.type === 'video') {
                videoPlayer.src = "/videos/" + item.path;
                videoPlayer.oncanplay = () => {
                    loader.style.display = 'none';
                    videoPlayer.style.display = 'block';
                    videoPlayer.play().catch(e => console.log("Autoplay blocked", e));
                    videoPlayer.focus(); // Focus for keyboard controls
                };
            } else {
                imageViewer.src = "/videos/" + item.path; // Assuming images are served via same route or static
                imageViewer.onload = () => {
                    loader.style.display = 'none';
                    imageViewer.style.display = 'block';
                };
            }
            // Reset controls visibility on new media load
            resetIdleTimer();
        }

        function navigate(direction) {
            // direction: -1 (prev) or 1 (next)
            currentIndex += direction;
            
            // Loop navigation
            if (currentIndex >= playlist.length) currentIndex = 0;
            if (currentIndex < 0) currentIndex = playlist.length - 1;
            
            loadMedia(currentIndex);
        }

        // --- 2. INPUT & IDLE HANDLING ---

        function resetIdleTimer() {
            // Show controls
            viewerContainer.classList.remove('idle');
            
            if (idleTimer) clearTimeout(idleTimer);

            // Hide controls after 2.5 seconds of inactivity
            idleTimer = setTimeout(() => {
                // Only hide if video is playing or just generally idle
                viewerContainer.classList.add('idle');
            }, 2500);
        }

        // Listen for activity to reset timer
        ['mousemove', 'mousedown', 'touchstart', 'click', 'keydown'].forEach(evt => {
            viewerContainer.addEventListener(evt, resetIdleTimer, { passive: true });
        });

        // Keyboard Navigation
        document.addEventListener('keydown', (e) => {
            if (viewerContainer.style.display === 'none') return;

            if (e.key === 'Escape' || e.key === 'f') closeViewer();
            if (e.key === 'ArrowLeft') navigate(-1);
            if (e.key === 'ArrowRight') navigate(1);
        });

        // --- 3. SWIPE HANDLING ---
        
        let touchStartX = 0;
        let touchStartY = 0;
        const minSwipeDistance = 50;

        viewerContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, {passive: false}); // passive: false allows us to preventDefault if needed

        viewerContainer.addEventListener('touchmove', (e) => {
            // If we want to be absolutely sure Chrome doesn't swipe-nav:
            e.preventDefault(); 
        }, {passive: false});

        viewerContainer.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            
            const xDiff = touchStartX - touchEndX;
            const yDiff = touchStartY - touchEndY;

            // Only trigger if horizontal swipe is dominant (more horizontal than vertical)
            if (Math.abs(xDiff) > Math.abs(yDiff)) {
                if (Math.abs(xDiff) > minSwipeDistance) {
                    if (xDiff > 0) navigate(1); // Swiped Left -> Next
                    else navigate(-1);          // Swiped Right -> Prev
                }
            }
        }, {passive: true});

        // --- 4. PREVIEW LOGIC (Unchanged) ---
        function startPreview(element, previewUrl) {
            const previewVideo = element.querySelector('.video-preview');
            const thumbnail = element.querySelector('.media-thumbnail');
            if (previewVideo && !previewVideo.src) {
                previewVideo.src = previewUrl;
                previewVideo.load();
            }
            if (previewVideo) {
                thumbnail.style.opacity = '0';
                previewVideo.style.display = 'block';
                previewVideo.currentTime = 0;
                previewVideo.play().catch(e => {});
            }
        }
        
        function stopPreview(element) {
            const previewVideo = element.querySelector('.video-preview');
            const thumbnail = element.querySelector('.media-thumbnail');
            if (previewVideo) {
                previewVideo.pause();
                previewVideo.style.display = 'none';
                thumbnail.style.opacity = '1';
            }
        }
    </script>
</body>
</html>